```mermaid
flowchart LR

    节点2 --> 节点1
    节点3 --> 节点1
    节点4 --> 节点1
    节点5 --> 节点1
    节点3 --> 节点2
    节点4 --> 节点2
    节点5 --> 节点2
    节点4 --> 节点3
    节点5 --> 节点3
    节点5 --> 节点4

```

- 成本估算
- 路径寻优
- 数据发送策略(单拨 组播 广播)
- 传输协议

```mermaid
flowchart LR

    subgraph 当前节点

        当前实例 -.->|当前实例ID| 节点实例
        当前实例 --> 路由表
        当前实例 --> 连接创建者

        路由表 --> 节点实例
        节点实例 --> 节点状态
        节点实例 --> 流创建者
        节点实例 --> 会话列表
        会话列表 --> 延迟测试服务
        会话列表 --> 状态同步服务
        会话列表 --> 业务层服务

    end

```

```mermaid
sequenceDiagram

    participant 业务层
    participant p2p实例
    participant 客户端
    participant 客户端连接
    participant 客户端流
    participant 服务端流
    participant 服务端连接
    participant 服务端

    par 对等体
        p2p实例 -->> 客户端: 引用
        客户端 ->> 客户端连接: 创建连接
        服务端 ->> 服务端连接: Accept
        客户端连接 ->> 服务端连接: 建立连接
        客户端连接 -->> p2p实例: 存储连接句柄
        服务端连接 -->> p2p实例: 存储连接句柄

        loop 客户端打开流
            客户端连接 ->> 客户端流: 打开流
            服务端连接 ->> 服务端流: 接受流
            客户端流 ->>+ 服务端流: 建立流
        end
        loop 服务端打开流
            服务端连接 ->> 客户端流: 打开流
            客户端连接 ->> 服务端流: 接受流
            客户端流 ->> 服务端流: 建立流
        end

        par 链路协商
            loop 中继
                客户端流 -->> 服务端流: 链路信息
                服务端流 -->> p2p实例: 获取下一个节点的连接句柄
                p2p实例 ->> 客户端流: 使用连接句柄打开流
                客户端流 ->> 服务端流: 建立流
                客户端流 -->> 服务端流: 下一跳链路信息
                客户端流 -->> 服务端流: Buffer双向复制
            end

            critical 直连
                客户端流 -->> 服务端流: 服务路由
                客户端流 -->> 服务端流: 服务参数信息
                服务端流 ->>- 客户端流: 流创建完成
            end
        end

        par 交换节点信息
            客户端流 -->>+ 服务端流: 节点信息
            服务端流 -->> p2p实例: 伙伴节点端点
        end

        loop 介绍伙伴节点
            服务端流 -->> 客户端流: 其他节点信息
            客户端流 -->> p2p实例: 其他节点端点
            客户端 ->> 客户端连接: 创建伙伴节点客户端连接
        end

        loop 延迟测试
            客户端流 -->> 服务端流: Ping
            服务端流 -->> 客户端流: Pong
            客户端流 -->> p2p实例: 延迟
            服务端流 -->> p2p实例: 对端延迟汇总
            p2p实例 -->> p2p实例: 较优路径规划排名
        end

        p2p实例 ->> 客户端连接: 删除客户端
        客户端连接 ->> 服务端连接: 断开连接
        服务端连接 -->> 服务端流: EOF结束符
        服务端流 -->>- p2p实例: 删除客户端节点信息
    end

    par 创建业务层服务
        业务层 ->> p2p实例: 根据PeerID获取连接句柄
        p2p实例 ->> 客户端流: 使用连接句柄打开流
        客户端流 ->> 服务端流: 建立流
        客户端流 -->> 服务端流: 链路信息
        客户端流 -->> 服务端流: 服务路由
        服务端流 ->> 业务层: 流创建完成
    end

```
